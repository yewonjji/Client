<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>과일 충돌 테스트</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            overflow: hidden;
        }
        canvas {
            display: block;
            background-color: #d3d3d3;
            margin: auto;
        }
        button {
            margin: 20px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>핸드폰을 거꾸로 들면 과일이 떨어지고 부딪힙니다!</h2>
    <button onclick="requestPermission()">자이로 센서 활성화</button>
    <canvas id="world"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        // Matter.js 기본 설정
        const { Engine, Render, Runner, Bodies, World, Events } = Matter;

        const engine = Engine.create();
        const world = engine.world;

        // 캔버스 설정
        const canvas = document.getElementById("world");
        const render = Render.create({
            canvas: canvas,
            engine: engine,
            options: {
                width: window.innerWidth,
                height: 600,
                wireframes: false,
                background: "#d3d3d3"
            }
        });

        // 땅 추가 (바구니 역할)
        const ground = Bodies.rectangle(window.innerWidth / 2, 580, window.innerWidth, 40, { 
            isStatic: true, 
            render: { fillStyle: "brown" } 
        });

        // 과일 생성 함수 (색상으로 표시)
        function createFruit(x, y, label, color) {
            return Bodies.circle(x, y, 30, {
                restitution: 0.5,
                friction: 0.3,
                density: 0.002,
                label: label,
                isStatic: true,
                render: { fillStyle: color }
            });
        }

        // 사과 (빨간색) & 바나나 (노란색) 생성
        const apple = createFruit(window.innerWidth / 2 - 50, 100, "apple", "red");
        const banana = createFruit(window.innerWidth / 2 + 50, 100, "banana", "yellow");

        // 월드에 추가
        World.add(world, [ground, apple, banana]);

        // 물리 엔진 실행
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // ✅ 사용자 액션을 통한 자이로 센서 권한 요청
        function requestPermission() {
            if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === "granted") {
                            activateGyro();
                        } else {
                            alert("자이로 센서 권한이 필요합니다!");
                        }
                    })
                    .catch(console.error);
            } else {
                activateGyro(); // 안드로이드 또는 권한 요청이 필요 없는 브라우저
            }
        }

        // ✅ 핸드폰 기울기 감지 (자이로센서 활성화)
        function activateGyro() {
            window.addEventListener("deviceorientation", (event) => {
                let beta = event.beta; // 핸드폰의 앞뒤 기울기 (-180 ~ 180)

                if (beta < -160) { // 핸드폰이 거꾸로 뒤집히면
                    Matter.Body.setStatic(apple, false); // 사과 떨어짐
                    Matter.Body.setStatic(banana, false); // 바나나 떨어짐
                }
            });
        }

        // ✅ 사과가 땅에 닿으면 언리얼에 알림
        Events.on(engine, "collisionStart", (event) => {
            event.pairs.forEach((pair) => {
                if (pair.bodyA.label === "apple" && pair.bodyB === ground) {
                    notifyUnreal("apple_removed");
                    Matter.World.remove(world, pair.bodyA); // 사과 삭제
                }
            });
        });

        function notifyUnreal(eventType) {
            fetch("http://localhost:3000/notify", {
                method: "POST",
                body: JSON.stringify({ event: eventType }),
                headers: { "Content-Type": "application/json" }
            });
        }
    </script>
</body>
</html>
