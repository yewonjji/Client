<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼ì¼ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ë–¨ì–´ì§€ê¸°</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            overflow: hidden;
        }
        canvas {
            display: block;
            background-color: #d3d3d3;
            margin: auto;
        }
        button {
            margin: 20px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>í•¸ë“œí°ì„ ëŒë¦¬ë©´ ê³¼ì¼ë“¤ì´ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ë‚ ì•„ê°‘ë‹ˆë‹¤!</h2>
    <button onclick="requestPermission()">ìì´ë¡œ ì„¼ì„œ í™œì„±í™”</button>
    <canvas id="world"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        // Matter.js ê¸°ë³¸ ì„¤ì •
        const { Engine, Render, Runner, Bodies, World, Events } = Matter;

        const engine = Engine.create();
        const world = engine.world;

        // ìº”ë²„ìŠ¤ ì„¤ì •
        const canvas = document.getElementById("world");
        const render = Render.create({
            canvas: canvas,
            engine: engine,
            options: {
                width: window.innerWidth,
                height: 600,
                wireframes: false,
                background: "#d3d3d3"
            }
        });

        // ë•… ì¶”ê°€ (ë°”êµ¬ë‹ˆ ì—­í• , í™”ë©´ ì•„ë˜ìª½)
        const ground = Bodies.rectangle(window.innerWidth / 2, 580, window.innerWidth, 40, { 
            isStatic: true, 
            render: { fillStyle: "brown" } 
        });

        // ê³¼ì¼ ìƒì„± í•¨ìˆ˜ (ìƒ‰ìƒìœ¼ë¡œ í‘œì‹œ)
        function createFruit(x, y, label, color) {
            return Bodies.circle(x, y, 30, {
                restitution: 0.5, // ë°˜ë°œë ¥
                friction: 0.3, // ë§ˆì°°ë ¥
                density: 0.002, // ë°€ë„ (ë¬´ê²Œ)
                label: label,
                render: { fillStyle: color }
            });
        }

        // ì‚¬ê³¼ (ë¹¨ê°„ìƒ‰) & ë°”ë‚˜ë‚˜ (ë…¸ë€ìƒ‰) ìƒì„±
        const apple = createFruit(window.innerWidth / 2 - 50, 500, "apple", "red");
        const banana = createFruit(window.innerWidth / 2 + 50, 500, "banana", "yellow");

        // ì›”ë“œì— ì¶”ê°€
        World.add(world, [ground, apple, banana]);

        // ë¬¼ë¦¬ ì—”ì§„ ì‹¤í–‰
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // âœ… ì‚¬ìš©ì ì•¡ì…˜ì„ í†µí•œ ìì´ë¡œ ì„¼ì„œ ê¶Œí•œ ìš”ì²­
        function requestPermission() {
            if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === "granted") {
                            activateGyro();
                        } else {
                            alert("ìì´ë¡œ ì„¼ì„œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤!");
                        }
                    })
                    .catch(console.error);
            } else {
                activateGyro(); // ì•ˆë“œë¡œì´ë“œ ë˜ëŠ” ê¶Œí•œ ìš”ì²­ì´ í•„ìš” ì—†ëŠ” ë¸Œë¼ìš°ì €
            }
        }

        // âœ… í•¸ë“œí° ê¸°ìš¸ê¸° ê°ì§€ (ì¤‘ë ¥ ë°©í–¥ ë³€ê²½)
        function activateGyro() {
            window.addEventListener("deviceorientation", (event) => {
                let beta = event.beta; // ì•ë’¤ ê¸°ìš¸ê¸° (-180 ~ 180)
                let gamma = event.gamma; // ì¢Œìš° ê¸°ìš¸ê¸° (-90 ~ 90)

                let gravityX = gamma / 90; // ì¢Œìš° ì¤‘ë ¥ ì„¤ì •
                let gravityY = beta / 90; // ì•ë’¤ ì¤‘ë ¥ ì„¤ì •

                // ğŸ“Œ í•¸ë“œí°ì´ ê±°ê¾¸ë¡œ ë’¤ì§‘íˆë©´ ê³¼ì¼ì´ ìœ„ë¡œ ë‚ ì•„ê°
                if (beta < -160) {
                    engine.world.gravity.y = -1; // ì¤‘ë ¥ì„ ìœ„ìª½ìœ¼ë¡œ ì„¤ì •
                } else {
                    engine.world.gravity.y = 1; // ì •ìƒì ì¸ ì¤‘ë ¥ ì ìš©
                }

                // ì¢Œìš° ê¸°ìš¸ê¸°ì— ë”°ë¼ ì¤‘ë ¥ ì¡°ì • (ì™¼ìª½ìœ¼ë¡œ ê¸°ìš¸ì´ë©´ ì™¼ìª½ìœ¼ë¡œ ë–¨ì–´ì§)
                engine.world.gravity.x = gravityX;
            });
        }

        // âœ… ì‚¬ê³¼ê°€ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì–¸ë¦¬ì–¼ì— ì•Œë¦¼
        Events.on(engine, "afterUpdate", () => {
            [apple, banana].forEach((fruit) => {
                if (fruit.position.y < -50) { // í™”ë©´ ìœ„ë¡œ ë‚˜ê°€ë©´ ì‚­ì œ
                    notifyUnreal(`${fruit.label}_removed`);
                    Matter.World.remove(world, fruit);
                }
            });
        });

        function notifyUnreal(eventType) {
            fetch("http://localhost:3000/notify", {
                method: "POST",
                body: JSON.stringify({ event: eventType }),
                headers: { "Content-Type": "application/json" }
            });
        }
    </script>
</body>
</html>
